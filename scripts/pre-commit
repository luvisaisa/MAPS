#!/bin/bash
# MAPS Pre-commit Hook
# Runs tests before allowing commit
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

echo "üß™ Running pre-commit tests for MAPS..."
echo ""

# check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "‚ùå Error: Not in MAPS root directory"
    exit 1
fi

# track failures
WEB_FAILED=0
PYTHON_FAILED=0

# run web tests
if [ -d "web" ]; then
    echo "üì¶ Running web frontend tests..."
    cd web
    if ! npm run test:run --silent 2>&1 | grep -q "PASS"; then
        WEB_FAILED=1
        echo "‚ùå Web tests failed"
    else
        echo "‚úÖ Web tests passed"
    fi
    cd ..
    echo ""
fi

# run python tests
if command -v pytest &> /dev/null; then
    echo "üêç Running Python backend tests..."
    if ! pytest --tb=short -q 2>&1; then
        PYTHON_FAILED=1
        echo "‚ùå Python tests failed"
    else
        echo "‚úÖ Python tests passed"
    fi
    echo ""
fi

# check results
if [ $WEB_FAILED -ne 0 ] || [ $PYTHON_FAILED -ne 0 ]; then
    echo "‚ùå Tests failed. Commit aborted."
    echo ""
    echo "To skip this check, use: git commit --no-verify"
    echo "To run specific tests:"
    echo "  Web: cd web && npm test"
    echo "  Python: pytest -v"
    exit 1
fi

echo "‚úÖ All tests passed! Proceeding with commit."
echo ""
exit 0
